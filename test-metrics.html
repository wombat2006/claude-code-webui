<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics Dashboard Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #abb2bf;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #2d3748;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .metric-card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
        }
        .metric-card h3 {
            margin: 0 0 10px 0;
            color: #61dafb;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }
        .metric-item:last-child {
            border-bottom: none;
        }
        .metric-label {
            color: #c678dd;
        }
        .metric-value {
            color: #98c379;
            font-weight: bold;
        }
        .status-connected {
            color: #98c379;
        }
        .status-disconnected {
            color: #e06c75;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #61dafb;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        button:hover {
            background: #4fa8c7;
        }
        .log {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-item {
            margin: 5px 0;
            word-break: break-all;
        }
        .log-system { color: #79c0ff; }
        .log-llm { color: #a5f3fc; }
        .log-rag { color: #fbbf24; }
        .log-error { color: #f87171; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Claude Code WebUI - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>æ¥ç¶šçŠ¶æ³: <span id="connectionStatus" class="status-disconnected">æœªæ¥ç¶š</span></p>
        </div>

        <div class="controls">
            <button onclick="simulateLLMRequest()">LLMãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            <button onclick="simulateRAGSearch()">RAGæ¤œç´¢ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            <button onclick="requestSystemStats()">ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã®å–å¾—</button>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="metrics-grid">
            <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ -->
            <div class="metric-card">
                <h3>ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ </h3>
                <div class="metric-item">
                    <span class="metric-label">ãƒ¡ãƒ¢ãƒª (RSS):</span>
                    <span class="metric-value" id="system-rss">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">CPU:</span>
                    <span class="metric-value" id="system-cpu">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æœ€çµ‚æ›´æ–°:</span>
                    <span class="metric-value" id="system-updated">--</span>
                </div>
            </div>

            <!-- LLMãƒ¢ãƒ‡ãƒ« -->
            <div class="metric-card">
                <h3>ğŸ¤– LLMãƒ¢ãƒ‡ãƒ«</h3>
                <div id="llm-models">
                    <div class="metric-item">
                        <span class="metric-label">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</span>
                        <span class="metric-value">--</span>
                    </div>
                </div>
            </div>

            <!-- RAG -->
            <div class="metric-card">
                <h3>ğŸ“š RAGæ¤œç´¢</h3>
                <div class="metric-item">
                    <span class="metric-label">ãƒ’ãƒƒãƒˆç‡:</span>
                    <span class="metric-value" id="rag-hitrate">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ç·æ¤œç´¢æ•°:</span>
                    <span class="metric-value" id="rag-total">--</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">æœ€çµ‚å®Ÿè¡Œ:</span>
                    <span class="metric-value" id="rag-last">--</span>
                </div>
            </div>

            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ -->
            <div class="metric-card">
                <h3>ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³</h3>
                <div class="metric-item">
                    <span class="metric-label">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:</span>
                    <span class="metric-value" id="session-requests">0</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ãƒˆãƒ¼ã‚¯ãƒ³:</span>
                    <span class="metric-value" id="session-tokens">0</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">ã‚³ã‚¹ãƒˆ:</span>
                    <span class="metric-value" id="session-cost">$0.0000</span>
                </div>
            </div>
        </div>

        <div class="log" id="eventLog">
            <strong>ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°:</strong><br>
        </div>
    </div>

    <script>
        // Socket.IOæ¥ç¶š
        const socket = io(window.location.origin, {
            path: '/metrics-socket.io/'
        });
        
        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹çŠ¶æ…‹
        let metrics = {
            rag: { hits: 0, totalSearches: 0 },
            session: { requests: 0, tokens: 0, cost: 0 }
        };

        // ãƒ­ã‚°ç®¡ç†
        let lastSystemLogTime = 0;
        const SYSTEM_LOG_THROTTLE = 60000; // 1åˆ†é–“éš”ã§ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°åˆ¶é™
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'system') {
            // ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆãƒ­ã‚°ã®åˆ¶å¾¡
            if (type === 'system' && message.includes('ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ')) {
                const now = Date.now();
                if (now - lastSystemLogTime < SYSTEM_LOG_THROTTLE) {
                    return; // ã‚¹ã‚­ãƒƒãƒ—
                }
                lastSystemLogTime = now;
            }
            
            const logEl = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP', {timeZone: 'Asia/Tokyo'});
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(logItem);
            
            // ãƒ­ã‚°ãŒ100è¡Œã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            while (logEl.children.length > 100) {
                logEl.removeChild(logEl.firstChild);
            }
            
            logEl.scrollTop = logEl.scrollHeight;
        }

        // åˆæœŸåŒ–
        log('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...', 'system');
        
        // Socket.IOã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'æ¥ç¶šä¸­';
            document.getElementById('connectionStatus').className = 'status-connected';
            log('Socket.IOã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
        });
        
        socket.on('connect_error', (error) => {
            log(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'åˆ‡æ–­';
            document.getElementById('connectionStatus').className = 'status-disconnected';
            log('Socket.IOã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'error');
        });

        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('metrics:system', (data) => {
            log(`ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ: RSS ${data.rss}MB, CPU ${data.cpu}%`, 'system');
            document.getElementById('system-rss').textContent = `${data.rss}MB`;
            document.getElementById('system-cpu').textContent = `${data.cpu}%`;
            document.getElementById('system-updated').textContent = data.lastUpdated || 'ãªã—';
        });

        // åˆæœŸãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ•ãƒ©ã‚°
        let initialDataReceived = { daily: false, llm: new Set(), rag: false };
        
        socket.on('metrics:daily_update', (data) => {
            if (!initialDataReceived.daily) {
                log(`æ—¥åˆ¥çµ±è¨ˆèª­ã¿è¾¼ã¿: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ${data.requests}å›, ãƒˆãƒ¼ã‚¯ãƒ³${data.tokens.toLocaleString()}, ã‚³ã‚¹ãƒˆ$${data.cost.toFixed(4)}`, 'success');
                initialDataReceived.daily = true;
            }
        });

        socket.on('metrics:llm_health', (data) => {
            const latency = data.lastLatency || data.latency || 0;
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ã‚° (ä¸€åº¦ã ã‘)
            if (!initialDataReceived.llm.has(data.model)) {
                log(`${data.model}: çŠ¶æ…‹${data.status}, ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·${latency}ms`, 'llm');
                initialDataReceived.llm.add(data.model);
            }
            
            // UIè¡¨ç¤ºæ›´æ–°
            const modelsEl = document.getElementById('llm-models');
            const statusIcon = data.status === 'healthy' ? 'ğŸŸ¢' : 
                             data.status === 'degraded' ? 'ğŸŸ¡' : 'ğŸ”´';
            
            // æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«è¦ç´ ã‚’æ¢ã™ã‹æ–°ã—ãä½œæˆ
            let modelEl = document.getElementById(`llm-${data.model}`);
            if (!modelEl) {
                modelEl = document.createElement('div');
                modelEl.id = `llm-${data.model}`;
                modelEl.className = 'metric-item';
                
                // æœ€åˆã®ã‚¢ã‚¤ãƒ†ãƒ ãŒã€Œã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€ã®å ´åˆã¯å‰Šé™¤
                const placeholderEl = modelsEl.querySelector('.metric-item');
                if (placeholderEl && placeholderEl.textContent.includes('ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“')) {
                    placeholderEl.remove();
                }
                
                modelsEl.appendChild(modelEl);
            }
            
            modelEl.innerHTML = `
                <span class="metric-label">${statusIcon} ${data.model}:</span>
                <span class="metric-value">${latency}ms</span>
            `;
        });

        socket.on('metrics:rag_update', (data) => {
            if (!initialDataReceived.rag && data.totalSearches > 0) {
                const hitRate = ((data.hits/data.totalSearches)*100).toFixed(1);
                log(`RAGçµ±è¨ˆèª­ã¿è¾¼ã¿: ãƒ’ãƒƒãƒˆç‡${hitRate}%, ç·æ¤œç´¢${data.totalSearches}å›`, 'rag');
                initialDataReceived.rag = true;
            }
        });

        socket.on('metrics:llm_complete', (data) => {
            log(`LLMå®Œäº†: ${data.model} - ${data.tokens}ãƒˆãƒ¼ã‚¯ãƒ³, $${data.cost}, ${data.latency}ms`, 'llm');
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆæ›´æ–°
            metrics.session.requests++;
            metrics.session.tokens += data.tokens;
            metrics.session.cost += data.cost;
            
            document.getElementById('session-requests').textContent = metrics.session.requests;
            document.getElementById('session-tokens').textContent = metrics.session.tokens.toLocaleString();
            document.getElementById('session-cost').textContent = `$${metrics.session.cost.toFixed(4)}`;
        });

        socket.on('metrics:rag_search', (data) => {
            log(`RAGæ¤œç´¢: ${data.results}ä»¶ã®çµæœ, ${data.processingTime}ms`, 'rag');
            
            // RAGçµ±è¨ˆæ›´æ–°
            metrics.rag.totalSearches++;
            if (data.hasResults) {
                metrics.rag.hits++;
            }
            
            const hitRate = metrics.rag.totalSearches > 0 
                ? Math.round((metrics.rag.hits / metrics.rag.totalSearches) * 100)
                : 0;
            
            document.getElementById('rag-hitrate').textContent = `${hitRate}%`;
            document.getElementById('rag-total').textContent = metrics.rag.totalSearches;
            document.getElementById('rag-last').textContent = new Date().toLocaleTimeString();
        });


        // åˆ¶å¾¡é–¢æ•°
        function simulateLLMRequest() {
            const models = ['claude-4', 'gpt-5', 'gemini-2.5-pro'];
            const model = models[Math.floor(Math.random() * models.length)];
            const tokens = Math.floor(Math.random() * 2000) + 500;
            const cost = tokens * 0.000003; // ç°¡å˜ãªã‚³ã‚¹ãƒˆè¨ˆç®—
            const latency = Math.floor(Math.random() * 2000) + 800;
            
            socket.emit('test:simulate_llm', {
                sessionId: 'test-session-dashboard',
                model,
                tokens,
                cost,
                latency,
                success: Math.random() > 0.1 // 90%æˆåŠŸç‡
            });
        }

        function simulateRAGSearch() {
            const queries = ['memory optimization', 'socket.io integration', 'dashboard metrics'];
            const query = queries[Math.floor(Math.random() * queries.length)];
            const hasResults = Math.random() > 0.3; // 70%ãƒ’ãƒƒãƒˆç‡
            const results = hasResults ? 
                Array.from({length: Math.floor(Math.random() * 3) + 1}, (_, i) => ({
                    id: i + 1,
                    title: `Document ${i + 1}`
                })) : [];
            
            socket.emit('test:simulate_rag', {
                sessionId: 'test-session-dashboard',
                query,
                results,
                processingTime: Math.floor(Math.random() * 300) + 100
            });
        }

        function requestSystemStats() {
            socket.emit('metrics:request_system');
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '<strong>ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°:</strong><br>';
        }

        // åˆæœŸåŒ–
        log('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...', 'system');
        
        // 5ç§’ã”ã¨ã«ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        setInterval(requestSystemStats, 5000);
    </script>
</body>
</html>